<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scribe - Voice to SOAP Notes</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-deepest: #0a1520;
            --bg-card: #0f1d2a;
            --bg-input: #132232;
            --bg-hover: #1a2d3f;
            --border: #1e3a4f;
            --border-focus: #2d5a7b;
            --teal: #4ecdc4;
            --teal-dark: #3ba89f;
            --teal-glow: rgba(78, 205, 196, 0.3);
            --red: #e74c3c;
            --red-dark: #2d1518;
            --amber: #f0a500;
            --green: #2ecc71;
            --text-primary: #e8eef4;
            --text-secondary: #8a9bae;
            --text-muted: #5a6a7a;
            --text-faint: #3a4a5a;
        }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-deepest); color: var(--text-primary); min-height: 100vh; }
        .hidden { display: none !important; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 400px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px; }
        .auth-logo { text-align: center; margin-bottom: 32px; }
        .logo-mark { display: inline-flex; width: 56px; height: 56px; background: linear-gradient(135deg, var(--teal), var(--teal-dark)); border-radius: 12px; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; font-size: 28px; color: white; margin-bottom: 12px; }
        .auth-logo h1 { font-family: 'Playfair Display', serif; font-size: 2rem; }
        .auth-logo .subtitle { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .auth-tabs { display: flex; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
        .auth-tab { flex: 1; padding: 12px; background: none; border: none; font-size: 1rem; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; }
        .auth-tab.active { color: var(--text-primary); border-bottom-color: var(--teal); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 14px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem; }
        .form-input:focus { outline: none; border-color: var(--teal); }
        .btn { padding: 14px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: #0a1520; box-shadow: 0 4px 15px var(--teal-glow); }
        .btn-primary:hover { box-shadow: 0 6px 20px var(--teal-glow); }
        .auth-error { display: none; padding: 12px; background: var(--red-dark); border-left: 3px solid var(--red); color: var(--red); margin-bottom: 20px; border-radius: 4px; }
        .auth-error.visible { display: block; }
        .header { background: linear-gradient(180deg, #12232f, var(--bg-deepest)); border-bottom: 1px solid var(--border); padding: 12px 20px; }
        .header-inner { max-width: 1000px; margin: 0 auto; display: flex; align-items: center; gap: 16px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo .logo-mark { width: 40px; height: 40px; font-size: 20px; border-radius: 10px; margin-bottom: 0; }
        .logo-text h1 { font-family: 'Playfair Display', serif; font-size: 1.4rem; line-height: 1.1; }
        .logo-text .subtitle { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .header-right { margin-left: auto; display: flex; align-items: center; gap: 16px; }
        .status-badge { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-family: 'DM Mono', monospace; font-size: 0.7rem; text-transform: uppercase; background: var(--bg-card); color: var(--text-muted); }
        .status-badge.listening { background: var(--red-dark); color: var(--red); }
        .status-badge.processing { background: rgba(91,155,213,0.2); color: #5b9bd5; }
        .status-badge.done { background: rgba(78,205,196,0.15); color: var(--teal); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        .status-badge.listening .status-dot, .status-badge.processing .status-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .user-info { font-family: 'DM Mono', monospace; font-size: 0.8rem; color: var(--text-muted); }
        .btn-logout { background: none; border: none; color: var(--text-muted); cursor: pointer; font-family: 'DM Mono', monospace; font-size: 0.75rem; }
        .btn-logout:hover { color: var(--text-secondary); }
        .tabs { background: var(--bg-card); border-bottom: 1px solid var(--border); }
        .tabs-inner { max-width: 1000px; margin: 0 auto; display: flex; padding: 0 20px; }
        .tab { padding: 14px 24px; background: none; border: none; font-size: 0.95rem; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; }
        .tab:hover { color: var(--text-secondary); }
        .tab.active { color: var(--text-primary); border-bottom-color: var(--teal); }
        .sub-tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 4px; }
        .sub-tab { flex: 1; padding: 10px 16px; background: var(--bg-card); border: none; border-bottom: 2px solid transparent; border-radius: 8px 8px 0 0; font-size: 0.9rem; color: var(--text-muted); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; opacity: 0.6; }
        .sub-tab:hover { color: var(--text-secondary); background: var(--bg-hover); opacity: 0.8; }
        .sub-tab.active { background: var(--bg-input); color: var(--teal); border-bottom: 2px solid var(--teal); opacity: 1; }
        .sub-tab-badge { display: none; padding: 2px 6px; border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 0.6rem; font-weight: 600; text-transform: uppercase; background: var(--teal); color: #0a1520; animation: pulse 1.5s infinite; }
        .sub-tab-badge.visible { display: inline-block; }
        .sub-content { display: none; }
        .sub-content.active { display: block; }
        .main-content { max-width: 1000px; margin: 0 auto; padding: 24px 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dictation-area { display: flex; gap: 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .mic-column { flex: 0 0 90px; display: flex; flex-direction: column; align-items: center; padding-top: 24px; }
        .mic-btn { width: 72px; height: 72px; border-radius: 50%; border: 2px solid var(--teal); background: linear-gradient(145deg, var(--bg-card), var(--bg-input)); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .mic-btn:hover { border-color: var(--teal); box-shadow: 0 0 15px var(--teal-glow); }
        .mic-btn svg { width: 28px; height: 28px; fill: var(--teal); transition: fill 0.2s; }
        .mic-btn:hover svg { fill: var(--text-primary); }
        .mic-btn.recording { background: linear-gradient(145deg, var(--red-dark), #1a0a0a); border-color: var(--red); }
        .mic-btn.recording svg { fill: var(--red); }
        .mic-hint { margin-top: 10px; font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; text-align: center; }
        .wave-bars { display: none; gap: 3px; height: 24px; align-items: center; margin-top: 10px; }
        .wave-bars.active { display: flex; }
        .wave-bar { width: 3px; background: var(--red); border-radius: 2px; animation: wave 0.5s ease-in-out infinite; }
        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.1s; }
        .wave-bar:nth-child(5) { animation-delay: 0s; }
        @keyframes wave { 0%,100% { height: 8px; } 50% { height: 20px; } }
        .textarea-column { flex: 1; display: flex; flex-direction: column; }
        .textarea-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .textarea-hint { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .textarea-hint.listening { color: var(--red); }
        .word-count { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--text-muted); }
        .textarea-wrapper { position: relative; flex: 1; }
        .dictation-textarea { width: 100%; height: 180px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 14px; color: var(--text-primary); font-size: 0.95rem; line-height: 1.5; resize: none; }
        .dictation-textarea:focus { outline: none; border-color: var(--border-focus); }
        .dictation-textarea.listening { background: var(--red-dark); border-color: rgba(231,76,60,0.4); }
        .interim-overlay { display: none; position: absolute; bottom: 8px; left: 8px; right: 8px; padding: 10px 12px; background: rgba(231,76,60,0.1); border: 1px solid rgba(231,76,60,0.3); border-radius: 6px; font-style: italic; color: #e8a090; font-size: 0.9rem; }
        .interim-overlay.active { display: block; }
        @media (max-width: 600px) { .dictation-area { flex-direction: column; } .mic-column { flex: none; padding-top: 0; padding-bottom: 16px; } }
        .demographics-bar { display: none; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; margin-bottom: 16px; }
        .demographics-bar.visible { display: block; }
        .demographics-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .demographics-title { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--teal); display: flex; align-items: center; gap: 6px; }
        .demographics-hint { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--text-muted); }
        .demographics-pills { display: flex; flex-wrap: wrap; gap: 8px; }
        .demo-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .demo-pill:hover { border-color: var(--border-focus); }
        .demo-pill-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; }
        .demo-pill-value { color: var(--text-primary); }
        .demo-pill-dot { width: 6px; height: 6px; border-radius: 50%; }
        .demo-pill-dot.high { background: var(--green); }
        .demo-pill-dot.medium { background: var(--amber); }
        .demo-pill-dot.low { background: var(--red); }
        .actions { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .btn-sample { background: transparent; border: 1px dashed var(--border); color: var(--text-muted); font-family: 'DM Mono', monospace; font-size: 0.8rem; padding: 10px 16px; }
        .btn-sample:hover { border-color: var(--text-muted); color: var(--text-secondary); }
        .actions-right { margin-left: auto; display: flex; gap: 10px; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 10px 20px; }
        .btn-secondary:hover { border-color: var(--border-focus); color: var(--text-primary); }
        .btn-generate { background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: #0a1520; font-weight: 600; padding: 10px 24px; box-shadow: 0 4px 15px var(--teal-glow); }
        .btn-generate:hover { box-shadow: 0 6px 20px var(--teal-glow); }
        .btn-generate:disabled { background: linear-gradient(135deg, #1e3a5f, #152535); color: #5b9bd5; box-shadow: none; cursor: not-allowed; }
        .workflow { display: flex; align-items: center; justify-content: center; gap: 4px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; }
        .workflow-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; margin-right: 12px; }
        .workflow-step { display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--text-muted); }
        .workflow-step.active { background: var(--bg-hover); color: var(--text-secondary); }
        .workflow-step.done { color: var(--teal); }
        .workflow-arrow { color: var(--text-faint); font-size: 0.6rem; }
        .soap-empty { text-align: center; padding: 80px 20px; color: var(--text-muted); }
        .soap-empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        .soap-empty-text { font-family: 'DM Mono', monospace; font-size: 0.9rem; }
        .soap-full { display: none; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .soap-full.visible { display: block; }
        .soap-title-bar { padding: 16px 18px; background: var(--bg-input); border-bottom: 1px solid var(--border); }
        .soap-title { font-family: 'DM Mono', monospace; font-size: 1.1rem; color: var(--text-primary); font-weight: 500; }
        .soap-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; background: var(--bg-card); border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 12px; }
        .soap-toolbar-left { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .soap-meta-tag { font-family: 'DM Mono', monospace; font-size: 0.75rem; padding: 5px 10px; background: var(--bg-hover); border-radius: 5px; color: var(--text-secondary); }
        .soap-saved { font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--teal); display: none; align-items: center; gap: 4px; }
        .soap-action-bar { padding: 18px; background: var(--bg-input); border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .btn-copy-large { background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: #0a1520; font-weight: 600; padding: 14px 32px; font-size: 1rem; min-height: 48px; box-shadow: 0 4px 15px var(--teal-glow); border-radius: 8px; }
        .btn-copy-large:hover { box-shadow: 0 6px 20px var(--teal-glow); }
        .btn-email { background: transparent; border: 2px solid var(--teal); color: var(--teal); padding: 14px 24px; font-size: 1rem; min-height: 48px; font-weight: 500; border-radius: 8px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-email:hover { background: rgba(78, 205, 196, 0.1); box-shadow: 0 4px 15px var(--teal-glow); }
        .btn-email:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .soap-body { padding: 18px; }
        .soap-label-input { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 18px; }
        .soap-label-input:focus { outline: none; border-color: var(--border-focus); }
        .soap-output { white-space: pre-wrap; line-height: 1.7; font-size: 0.95rem; }
        .soap-section-header { display: block; background: linear-gradient(135deg, var(--bg-input), var(--bg-hover)); border-left: 4px solid var(--teal); padding: 10px 14px; margin: 20px 0 12px 0; font-family: 'DM Mono', monospace; font-size: 0.85rem; font-weight: 600; letter-spacing: 1px; color: var(--teal); text-transform: uppercase; }
        .soap-section-header:first-child { margin-top: 0; }
        .soap-subheader { font-weight: 600; color: var(--text-primary); }
        .soap-output strong { color: var(--text-primary); font-weight: 600; }
        .soap-disclaimer { font-size: 0.8rem; font-style: italic; color: var(--text-muted); display: block; margin-top: 8px; }
        .soap-plan-item { display: block; padding-left: 1.5em; text-indent: -1.5em; }
        .soap-plan-subitem { display: block; padding-left: 2.5em; text-indent: -1em; }
        .soap-footer { padding: 16px 18px; border-top: 1px solid var(--border); display: flex; justify-content: center; }
        .btn-new-patient { background: transparent; border: 2px solid var(--teal); color: var(--teal); padding: 14px 32px; font-size: 1rem; min-height: 48px; font-weight: 500; border-radius: 8px; }
        .btn-new-patient:hover { background: rgba(78, 205, 196, 0.1); border-color: var(--teal); color: var(--teal); box-shadow: 0 4px 15px var(--teal-glow); }
        .notes-list { display: flex; flex-direction: column; gap: 10px; }
        .note-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; cursor: pointer; transition: all 0.2s; }
        .note-card:hover { border-color: var(--border-focus); }
        .note-card.expanded { border-color: var(--teal); }
        .note-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
        .note-title { font-family: "DM Mono", monospace; font-size: 0.95rem; font-weight: 400; }
        .note-label { font-size: 0.8rem; color: var(--text-muted); font-style: italic; margin-top: 4px; }
        .note-content { display: none; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
        .note-card.expanded .note-content { display: block; }
        .note-actions { margin-top: 14px; display: flex; gap: 8px; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .date-group { margin-bottom: 20px; }
        .date-group-header { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; padding-left: 4px; }
        .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--teal); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        .btn-danger { background: var(--red-dark); border: 1px solid rgba(231,76,60,0.3); color: var(--red); }
    </style>
</head>
<body>
    <div id="auth-screen" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <div class="logo-mark">S</div>
                <h1>Scribe</h1>
                <div class="subtitle">Voice to SOAP Notes</div>
            </div>
            <div id="auth-error" class="auth-error"></div>
            <div class="auth-tabs">
                <button class="auth-tab active" data-form="login">Sign In</button>
                <button class="auth-tab" data-form="register">Register</button>
            </div>
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Sign In</button>
                <div style="text-align:center;margin-top:16px;">
                    <a href="#" id="forgot-password-link" style="color:var(--teal);font-size:0.9rem;">Forgot Password?</a>
                </div>
            </form>
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="register-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="register-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Password (min 8 chars)</label>
                    <input type="password" id="register-password" class="form-input" required minlength="8">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Create Account</button>
            </form>
            <div id="verify-form" class="auth-form">
                <p style="text-align:center;color:var(--text-secondary);margin-bottom:20px;">
                    Enter the 6-digit code sent to<br><strong id="verify-email-display"></strong>
                </p>
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="verify-code" class="form-input" maxlength="6" style="text-align:center;font-size:1.5rem;letter-spacing:8px;">
                </div>
                <button type="button" id="verify-btn" class="btn btn-primary" style="width:100%">Verify</button>
            </div>
            <div id="forgot-form" class="auth-form">
                <p style="text-align:center;color:var(--text-secondary);margin-bottom:20px;">
                    Enter your email address and we'll send you a code to reset your password.
                </p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgot-email" class="form-input" required>
                </div>
                <button type="button" id="forgot-btn" class="btn btn-primary" style="width:100%">Send Reset Code</button>
                <div style="text-align:center;margin-top:16px;">
                    <a href="#" id="back-to-login-link" style="color:var(--text-muted);font-size:0.9rem;">Back to Sign In</a>
                </div>
            </div>
            <div id="reset-form" class="auth-form">
                <p style="text-align:center;color:var(--text-secondary);margin-bottom:20px;">
                    Enter the 6-digit code sent to<br><strong id="reset-email-display"></strong>
                </p>
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="reset-code" class="form-input" maxlength="6" style="text-align:center;font-size:1.5rem;letter-spacing:8px;">
                </div>
                <div class="form-group">
                    <label>New Password (min 8 chars)</label>
                    <input type="password" id="reset-password" class="form-input" required minlength="8">
                </div>
                <button type="button" id="reset-btn" class="btn btn-primary" style="width:100%">Reset Password</button>
            </div>
        </div>
    </div>
    <div id="main-app" class="hidden">
        <header class="header">
            <div class="header-inner">
                <div class="logo">
                    <div class="logo-mark">S</div>
                    <div class="logo-text">
                        <h1>Scribe</h1>
                        <div class="subtitle">Voice ‚Üí SOAP Notes</div>
                    </div>
                </div>
                <div class="header-right">
                    <span class="user-info" id="user-name"></span>
                    <button class="btn-logout" id="logout-btn">Logout</button>
                    <div class="status-badge" id="status-badge">
                        <span class="status-dot"></span>
                        <span id="status-text">Ready</span>
                    </div>
                </div>
            </div>
        </header>
        <div class="tabs">
            <div class="tabs-inner">
                <button class="tab active" data-tab="new">New Note</button>
                <button class="tab" data-tab="notes">My Notes</button>
            </div>
        </div>
        <div class="main-content">
            <div id="tab-new" class="tab-content active">
                <div class="sub-tabs">
                    <button class="sub-tab active" data-subtab="dictation">üéô Dictation</button>
                    <button class="sub-tab" data-subtab="soap">üìã SOAP Note <span class="sub-tab-badge" id="soap-ready-badge">Ready</span></button>
                </div>
                <div id="subtab-dictation" class="sub-content active">
                    <div class="dictation-area">
                        <div class="mic-column">
                            <button class="mic-btn" id="mic-btn">
                                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
                            </button>
                            <div class="mic-hint" id="mic-hint">Tap to speak</div>
                            <div class="wave-bars" id="wave-bars">
                                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                            </div>
                        </div>
                        <div class="textarea-column">
                            <div class="textarea-header">
                                <span class="textarea-hint" id="textarea-hint">Speak or type raw clinical notes</span>
                                <span class="word-count" id="word-count">0 words</span>
                            </div>
                            <div class="textarea-wrapper">
                                <textarea id="dictation" class="dictation-textarea" placeholder="Patient presentation, history, exam findings, assessment and plan..."></textarea>
                                <div class="interim-overlay" id="interim-overlay"></div>
                            </div>
                        </div>
                    </div>
                    <div class="demographics-bar" id="demographics-bar">
                        <div class="demographics-header">
                            <span class="demographics-title">‚úì Auto-Detected</span>
                            <span class="demographics-hint">Click to override</span>
                        </div>
                        <div class="demographics-pills" id="demographics-pills"></div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-sample" id="sample-btn">‚Ü≥ Load Sample</button>
                        <div class="actions-right">
                            <button class="btn btn-secondary" id="clear-btn">Clear All</button>
                            <button class="btn btn-generate" id="generate-btn">Generate SOAP Note</button>
                        </div>
                    </div>
                    <div class="workflow" id="workflow">
                        <span class="workflow-label">Workflow</span>
                        <span class="workflow-step active" data-step="dictate">üéô Dictate</span>
                        <span class="workflow-arrow">‚Üí</span>
                        <span class="workflow-step" data-step="clean">üßπ Clean</span>
                        <span class="workflow-arrow">‚Üí</span>
                        <span class="workflow-step" data-step="detect">üîç Detect</span>
                        <span class="workflow-arrow">‚Üí</span>
                        <span class="workflow-step" data-step="process">‚öô Process</span>
                        <span class="workflow-arrow">‚Üí</span>
                        <span class="workflow-step" data-step="copy">üìã Copy</span>
                    </div>
                </div>
                <div id="subtab-soap" class="sub-content">
                    <div class="soap-empty" id="soap-empty">
                        <div class="soap-empty-icon">üìã</div>
                        <div class="soap-empty-text">Generate a note to see it here</div>
                    </div>
                    <div class="soap-full" id="soap-full">
                        <div class="soap-title-bar">
                            <div class="soap-title" id="soap-title"></div>
                        </div>
                        <div class="soap-toolbar">
                            <div class="soap-toolbar-left">
                                <span class="soap-meta-tag" id="soap-meta-demo"></span>
                                <span class="soap-meta-tag" id="soap-meta-visit"></span>
                                <span class="soap-meta-tag" id="soap-meta-complaint"></span>
                            </div>
                            <div class="soap-saved" id="soap-saved">‚úì Saved</div>
                        </div>
                        <div class="soap-action-bar">
                            <button class="btn btn-copy-large" id="copy-btn">üìã Copy to Clipboard</button>
                            <button class="btn btn-email" id="email-btn">‚úâÔ∏è Email to Me</button>
                            <button class="btn btn-new-patient" id="new-patient-top-btn">New Patient ‚Üí</button>
                        </div>
                        <div class="soap-body">
                            <input type="text" id="note-label" class="soap-label-input" placeholder="Add a personal label (optional)...">
                            <div class="soap-output" id="soap-output"></div>
                        </div>
                        <div class="soap-footer">
                            <button class="btn btn-email" id="email-btn-bottom">‚úâÔ∏è Email to Me</button>
                            <button class="btn btn-new-patient" id="new-patient-btn">New Patient ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-notes" class="tab-content">
                <div id="notes-loading" class="empty-state"><div class="spinner"></div></div>
                <div id="notes-empty" class="empty-state hidden">No notes yet. Create your first note!</div>
                <div id="notes-list" class="notes-list"></div>
            </div>
        </div>
    </div>
    <script>
    (function() {
        var currentUser = null;
        var pendingEmail = null;
        var notes = [];
        var demographics = {};
        var currentSoapNote = '';
        var currentNoteId = null;
        var soapReady = false;
        var currentSubTab = 'dictation';
        var encounterTime = null;
        
        function api(endpoint, options) {
            options = options || {};
            return fetch(endpoint, {
                method: options.method || 'GET',
                headers: { 'Content-Type': 'application/json' },
                body: options.body,
                credentials: 'same-origin'
            }).then(function(res) {
                return res.json().then(function(data) {
                    if (!res.ok) throw new Error(data.detail || 'Request failed');
                    return data;
                });
            });
        }
        
        function showAuth() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }
        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }
        function showError(msg) {
            var el = document.getElementById('auth-error');
            el.textContent = msg;
            el.classList.add('visible');
        }
        function hideError() {
            document.getElementById('auth-error').classList.remove('visible');
        }
        
        function setStatus(status, text) {
            var badge = document.getElementById('status-badge');
            badge.className = 'status-badge' + (status ? ' ' + status : '');
            document.getElementById('status-text').textContent = text || 'Ready';
        }
        
        function setWorkflowStep(step) {
            var steps = ['dictate', 'clean', 'detect', 'process', 'copy'];
            var idx = steps.indexOf(step);
            document.querySelectorAll('.workflow-step').forEach(function(el, i) {
                el.classList.remove('active', 'done');
                if (i < idx) el.classList.add('done');
                if (i === idx) el.classList.add('active');
            });
        }
        
        function switchSubTab(tab) {
            currentSubTab = tab;
            document.querySelectorAll('.sub-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.sub-content').forEach(function(c) { c.classList.remove('active'); });
            document.querySelector('.sub-tab[data-subtab="' + tab + '"]').classList.add('active');
            document.getElementById('subtab-' + tab).classList.add('active');
            if (tab === 'soap') {
                document.getElementById('soap-ready-badge').classList.remove('visible');
            }
        }
        
        document.querySelectorAll('.sub-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                switchSubTab(tab.dataset.subtab);
            });
        });
        // Capture encounter time on first interaction
        function captureEncounterTime() {
            if (!encounterTime) {
                encounterTime = new Date();
            }
        }
        
        // Generate note title from encounter time and demographics
        function generateNoteTitle(encTime, age, gender, chiefComplaint) {
            var parts = [];
            
            // Date and Time part
            if (encTime) {
                var d = new Date(encTime);
                var month = d.getMonth() + 1;
                var day = d.getDate();
                month = month < 10 ? '0' + month : month;
                day = day < 10 ? '0' + day : day;
                var hours = d.getHours();
                var mins = d.getMinutes();
                var ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12;
                mins = mins < 10 ? '0' + mins : mins;
                var year = String(d.getFullYear()).slice(-2); parts.push(month + '/' + day + '/' + year + ' ¬∑ ' + hours + ':' + mins + ' ' + ampm);
            }
            
            // Demographics part
            var demo = '';
            if (age) demo += age;
            if (gender) {
                var g = gender.toLowerCase();
                if (g === 'male' || g === 'm') demo += 'M';
                else if (g === 'female' || g === 'f') demo += 'F';
                else if (g === 'nonbinary' || g === 'nb') demo += 'NB';
                else demo += gender.charAt(0).toUpperCase();
            }
            if (demo) parts.push(demo);
            
            // Chief complaint
            if (chiefComplaint) {
                parts.push(chiefComplaint);
            }
            
            if (parts.length === 0) return 'Untitled Note';
            if (parts.length === 1 && encTime) return parts[0] + ' ¬∑ Untitled Note';
            return parts.join(' ¬∑ ');
        }
        
        function updateWordCount() {
            var text = document.getElementById('dictation').value.trim();
            var words = text ? text.split(/\s+/).length : 0;
            document.getElementById('word-count').textContent = words + ' word' + (words !== 1 ? 's' : '');
        }
        
        // Track first keystroke in textarea
        document.getElementById('dictation').addEventListener('input', function() {
            captureEncounterTime();
            updateWordCount();
        });
        
        document.querySelectorAll('.auth-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.auth-tab').forEach(function(t) { t.classList.remove('active'); });
                document.querySelectorAll('.auth-form').forEach(function(f) { f.classList.remove('active'); });
                tab.classList.add('active');
                document.getElementById(tab.dataset.form + '-form').classList.add('active');
                hideError();
            });
        });
        
        api('/api/auth/me').then(function(user) {
            currentUser = user;
            document.getElementById('user-name').textContent = user.name;
            showApp();
        }).catch(function() {
            showAuth();
        });
        
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            hideError();
            api('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({
                    email: document.getElementById('login-email').value,
                    password: document.getElementById('login-password').value
                })
            }).then(function(data) {
                currentUser = data.user;
                document.getElementById('user-name').textContent = data.user.name;
                showApp();
            }).catch(function(err) {
                showError(err.message);
            });
        });
        
        document.getElementById('register-form').addEventListener('submit', function(e) {
            e.preventDefault();
            hideError();
            var email = document.getElementById('register-email').value;
            api('/api/auth/register', {
                method: 'POST',
                body: JSON.stringify({
                    name: document.getElementById('register-name').value,
                    email: email,
                    password: document.getElementById('register-password').value
                })
            }).then(function() {
                pendingEmail = email;
                document.getElementById('verify-email-display').textContent = email;
                document.querySelectorAll('.auth-form').forEach(function(f) { f.classList.remove('active'); });
                document.getElementById('verify-form').classList.add('active');
                document.querySelectorAll('.auth-tab').forEach(function(t) { t.classList.remove('active'); });
            }).catch(function(err) {
                showError(err.message);
            });
        });
        
        document.getElementById('verify-btn').addEventListener('click', function() {
            hideError();
            api('/api/auth/verify', {
                method: 'POST',
                body: JSON.stringify({ email: pendingEmail, code: document.getElementById('verify-code').value })
            }).then(function() { location.reload(); }).catch(function(err) { showError(err.message); });
        });
        
        var resetEmail = '';
        
        document.getElementById('forgot-password-link').addEventListener('click', function(e) {
            e.preventDefault();
            hideError();
            document.querySelectorAll('.auth-form').forEach(function(f) { f.classList.remove('active'); });
            document.getElementById('forgot-form').classList.add('active');
            document.querySelector('.auth-tabs').style.display = 'none';
        });
        
        document.getElementById('back-to-login-link').addEventListener('click', function(e) {
            e.preventDefault();
            hideError();
            document.querySelectorAll('.auth-form').forEach(function(f) { f.classList.remove('active'); });
            document.getElementById('login-form').classList.add('active');
            document.querySelector('.auth-tabs').style.display = 'flex';
        });
        
        document.getElementById('forgot-btn').addEventListener('click', function() {
            hideError();
            var email = document.getElementById('forgot-email').value;
            if (!email) { showError('Please enter your email'); return; }
            
            this.disabled = true;
            this.textContent = 'Sending...';
            var btn = this;
            
            api('/api/auth/forgot-password', {
                method: 'POST',
                body: JSON.stringify({ email: email })
            }).then(function() {
                resetEmail = email;
                document.getElementById('reset-email-display').textContent = email;
                document.querySelectorAll('.auth-form').forEach(function(f) { f.classList.remove('active'); });
                document.getElementById('reset-form').classList.add('active');
            }).catch(function(err) {
                showError(err.message);
            }).finally(function() {
                btn.disabled = false;
                btn.textContent = 'Send Reset Code';
            });
        });
        
        document.getElementById('reset-btn').addEventListener('click', function() {
            hideError();
            var code = document.getElementById('reset-code').value;
            var newPassword = document.getElementById('reset-password').value;
            
            if (!code || code.length !== 6) { showError('Please enter the 6-digit code'); return; }
            if (!newPassword || newPassword.length < 8) { showError('Password must be at least 8 characters'); return; }
            
            this.disabled = true;
            this.textContent = 'Resetting...';
            var btn = this;
            
            api('/api/auth/reset-password', {
                method: 'POST',
                body: JSON.stringify({ email: resetEmail, code: code, new_password: newPassword })
            }).then(function() {
                alert('Password reset successfully! Please sign in with your new password.');
                document.querySelectorAll('.auth-form').forEach(function(f) { f.classList.remove('active'); });
                document.getElementById('login-form').classList.add('active');
                document.querySelector('.auth-tabs').style.display = 'flex';
                document.getElementById('login-email').value = resetEmail;
                document.getElementById('reset-code').value = '';
                document.getElementById('reset-password').value = '';
                document.getElementById('forgot-email').value = '';
            }).catch(function(err) {
                showError(err.message);
            }).finally(function() {
                btn.disabled = false;
                btn.textContent = 'Reset Password';
            });
        });
        
        document.getElementById('logout-btn').addEventListener('click', function() {
            api('/api/auth/logout', { method: 'POST' }).then(function() { location.reload(); });
        });
        
        document.querySelectorAll('.tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
                document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                if (tab.dataset.tab === 'notes') loadNotes();
            });
        });
        var recognition = null;
        var isRecording = false;
        var wakeLock = null;
        
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock acquired');
                } catch (err) {
                    console.log('Wake lock failed:', err);
                }
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake lock released');
            }
        }
        
        // Re-acquire wake lock if page becomes visible while recording
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && isRecording) {
                requestWakeLock();
            }
        });
        var lastAddedText = '';
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = false;
            recognition.interimResults = true;
            
            recognition.onresult = function(e) {
                var textarea = document.getElementById('dictation');
                var finalText = '';
                var interim = '';
                
                // Build complete final transcript from all final results
                for (var i = 0; i < e.results.length; i++) {
                    if (e.results[i].isFinal) {
                        finalText += e.results[i][0].transcript;
                    } else {
                        interim += e.results[i][0].transcript;
                    }
                }
                
                // Only add new text that wasn't added before
                finalText = finalText.trim();
                if (finalText && finalText !== lastAddedText) {
                    // Find what's new by comparing with last added
                    var newPart = finalText;
                    if (lastAddedText && finalText.indexOf(lastAddedText) === 0) {
                        newPart = finalText.substring(lastAddedText.length).trim();
                    }
                    
                    if (newPart) {
                        var current = textarea.value;
                        if (current && !current.endsWith(' ')) {
                            current += ' ';
                        }
                        textarea.value = current + newPart + ' ';
                    }
                    lastAddedText = finalText;
                }
                
                updateWordCount();
                
                var overlay = document.getElementById('interim-overlay');
                if (interim) {
                    overlay.textContent = interim;
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            };
            
            recognition.onerror = function() { stopRecording(); };
            recognition.onend = function() { if (isRecording) { stopRecording(); } };
        }
        
        function startRecording() {
            if (!recognition) return;
            captureEncounterTime();
            lastAddedText = '';
            isRecording = true;
            recognition.start();
            document.getElementById('mic-btn').classList.add('recording');
            requestWakeLock();
            document.getElementById('dictation').classList.add('listening');
            document.getElementById('mic-hint').textContent = 'Tap to stop';
            document.getElementById('textarea-hint').textContent = 'Listening - state patient gender & age first...';
            document.getElementById('textarea-hint').classList.add('listening');
            document.getElementById('wave-bars').classList.add('active');
            setStatus('listening', 'Listening');
            setWorkflowStep('dictate');
        }
        
        function stopRecording() {
            isRecording = false;
            if (recognition) recognition.stop();
            document.getElementById('mic-btn').classList.remove('recording');
            releaseWakeLock();
            document.getElementById('dictation').classList.remove('listening');
            document.getElementById('mic-hint').textContent = 'Tap to speak';
            document.getElementById('textarea-hint').textContent = 'Speak or type raw clinical notes';
            document.getElementById('textarea-hint').classList.remove('listening');
            document.getElementById('wave-bars').classList.remove('active');
            document.getElementById('interim-overlay').classList.remove('active');
            setStatus('', 'Ready');
        }
        
        document.getElementById('mic-btn').addEventListener('click', function() {
            if (isRecording) stopRecording(); else startRecording();
        });
        
        document.getElementById('sample-btn').addEventListener('click', function() {
            captureEncounterTime();
            document.getElementById('dictation').value = '29 year old female presenting to clinic with sore throat for 3 days. Reports pain with swallowing, mild fever, and fatigue. No cough or runny nose. Past medical history unremarkable. On exam, temperature 100.4F, pharynx erythematous with tonsillar exudates, tender anterior cervical lymphadenopathy. Rapid strep test positive. Assessment: Streptococcal pharyngitis. Plan: Amoxicillin 500mg TID for 10 days, rest, fluids, follow up if not improving in 48-72 hours.';
            updateWordCount();
            setWorkflowStep('dictate');
        });
        
        function clearAll() {
            document.getElementById('dictation').value = '';
            document.getElementById('soap-output').innerHTML = '';
            document.getElementById('soap-full').classList.remove('visible');
            document.getElementById('soap-empty').style.display = 'block';
            document.getElementById('demographics-bar').classList.remove('visible');
            document.getElementById('note-label').value = '';
            document.getElementById('soap-saved').style.display = 'none';
            currentNoteId = null;
            document.getElementById('soap-ready-badge').classList.remove('visible');
            document.getElementById('soap-title').textContent = '';
            demographics = {};
            soapReady = false;
            encounterTime = null;
            updateWordCount();
            setWorkflowStep('dictate');
            setStatus('', 'Ready');
            switchSubTab('dictation');
        }
        
        document.getElementById('clear-btn').addEventListener('click', clearAll);
        document.getElementById('new-patient-btn').addEventListener('click', clearAll);
        document.getElementById('new-patient-top-btn').addEventListener('click', clearAll);
        function renderDemographics(data) {
            demographics = data;
            var pills = document.getElementById('demographics-pills');
            pills.innerHTML = '';
            var fields = [
                { key: 'gender', label: 'Gender' },
                { key: 'age', label: 'Age' },
                { key: 'visitType', label: 'Visit' },
                { key: 'specialty', label: 'Specialty' },
                { key: 'chiefComplaint', label: 'Complaint' }
            ];
            var conf = data.confidence || 0.5;
            var dotClass = conf > 0.7 ? 'high' : conf > 0.4 ? 'medium' : 'low';
            
            fields.forEach(function(f) {
                if (!data[f.key]) return;
                var pill = document.createElement('span');
                pill.className = 'demo-pill';
                pill.innerHTML = '<span class="demo-pill-label">' + f.label + ':</span> <span class="demo-pill-value">' + data[f.key] + '</span> <span class="demo-pill-dot ' + dotClass + '"></span>';
                pills.appendChild(pill);
            });
            
            if (pills.children.length > 0) {
                document.getElementById('demographics-bar').classList.add('visible');
            }
        }
        
        // Deduplication safety net for speech recognition artifacts
        function deduplicateDictation(text) {
            if (!text) return text;
            var sentences = text.split(/[.?!]+/).map(function(s) { return s.trim(); }).filter(function(s) { return s; });
            if (sentences.length < 2) return text;
            var cleaned = [];
            var lastNorm = '';
            for (var i = 0; i < sentences.length; i++) {
                var norm = sentences[i].toLowerCase().replace(/[^a-z0-9\s]/g, '');
                if (norm !== lastNorm) {
                    cleaned.push(sentences[i]);
                    lastNorm = norm;
                }
            }
            return cleaned.join('. ') + '.';
        }
        
        document.getElementById('generate-btn').addEventListener('click', function() {
            var rawDictation = document.getElementById('dictation').value.trim();
            var dictation = deduplicateDictation(rawDictation);
            if (!dictation) return alert('Please enter some dictation first');
            
            var btn = this;
            btn.disabled = true;
            btn.textContent = 'Generating...';
            setStatus('processing', 'Processing');
            setWorkflowStep('detect');
            
            api('/api/generate/extract', {
                method: 'POST',
                body: JSON.stringify({ dictation: dictation })
            }).then(function(data) {
                renderDemographics(data);
                setWorkflowStep('process');
                
                return api('/api/generate/soap', {
                    method: 'POST',
                    body: JSON.stringify({
                        dictation: dictation,
                        gender: data.gender,
                        age: data.age,
                        visitType: data.visitType,
                        specialty: data.specialty,
                        chiefComplaint: data.chiefComplaint
                    })
                });
            }).then(function(data) {
                currentSoapNote = data.soap_note;
                var html = data.soap_note
                    .replace(/\*\*(SUBJECTIVE|OBJECTIVE|ASSESSMENT|PLAN):?\*\*/gi, '<div class="soap-section-header">$1</div>').replace(/^(SUBJECTIVE|OBJECTIVE|ASSESSMENT|PLAN):?$/gim, '<div class="soap-section-header">$1</div>')
                    .replace(/\(ICD-10 codes suggested[^)]*\)/g, '<span class="soap-disclaimer">$&</span>')
                    .replace(/^(\d+\.\s+.*)$/gm, '<span class="soap-plan-item">$1</span>')
                    .replace(/^(\s+-\s+.*)$/gm, '<span class="soap-plan-subitem">$1</span>')
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                document.getElementById('soap-output').innerHTML = html;
                
                // Generate and display title
                var title = generateNoteTitle(encounterTime, demographics.age, demographics.gender, demographics.chiefComplaint);
                document.getElementById('soap-title').textContent = title;
                
                var demoTag = document.getElementById('soap-meta-demo');
                var visitTag = document.getElementById('soap-meta-visit');
                var complaintTag = document.getElementById('soap-meta-complaint');
                
                demoTag.textContent = (demographics.age || '') + (demographics.gender ? ' ' + demographics.gender.charAt(0).toUpperCase() : '');
                demoTag.style.display = demoTag.textContent ? 'inline-block' : 'none';
                visitTag.textContent = demographics.visitType || '';
                visitTag.style.display = visitTag.textContent ? 'inline-block' : 'none';
                complaintTag.textContent = demographics.chiefComplaint || '';
                complaintTag.style.display = complaintTag.textContent ? 'inline-block' : 'none';
                
                document.getElementById('soap-empty').style.display = 'none';
                document.getElementById('soap-full').classList.add('visible');
                document.getElementById('soap-saved').style.display = 'none';
                
                soapReady = true;
                setWorkflowStep('copy');
                setStatus('done', 'Done');
                
                switchSubTab('soap');
                autoSaveNote();
                
            }).catch(function(err) {
                alert('Error: ' + err.message);
                setStatus('', 'Ready');
            }).finally(function() {
                btn.disabled = false;
                btn.textContent = 'Generate SOAP Note';
            });
        });
        function autoSaveNote() {
            var manualLabel = document.getElementById('note-label').value;
            var autoLabel = generateNoteTitle(encounterTime, demographics.age, demographics.gender, demographics.chiefComplaint);
            var finalLabel = manualLabel || autoLabel;
            
            api('/api/notes', {
                method: 'POST',
                body: JSON.stringify({
                    label: finalLabel,
                    patient_age: demographics.age || null,
                    patient_gender: demographics.gender || null,
                    visit_type: demographics.visitType || null,
                    specialty: demographics.specialty || null,
                    chief_complaint: demographics.chiefComplaint || null,
                    raw_dictation: document.getElementById('dictation').value,
                    soap_note: currentSoapNote,
                    encounter_time: encounterTime ? encounterTime.toISOString() : null
                })
            }).then(function(data) {
                currentNoteId = data.id;
                document.getElementById('soap-saved').style.display = 'flex';
            }).catch(function(err) {
                console.error('Auto-save failed:', err);
            });
        }
        
        function emailNote(btn) {
            if (!currentNoteId) {
                alert('Please wait for the note to save first');
                return;
            }
            btn.disabled = true;
            var origText = btn.innerHTML;
            btn.innerHTML = 'Sending...';
            
            api('/api/notes/' + currentNoteId + '/email', { method: 'POST' })
                .then(function() {
                    btn.innerHTML = '‚úì Sent!';
                    setTimeout(function() { btn.innerHTML = origText; btn.disabled = false; }, 2000);
                })
                .catch(function(err) {
                    alert('Failed to send: ' + err.message);
                    btn.innerHTML = origText;
                    btn.disabled = false;
                });
        }
        
        document.getElementById('email-btn').addEventListener('click', function() {
            emailNote(this);
        });
        
        document.getElementById('email-btn-bottom').addEventListener('click', function() {
            emailNote(this);
        });
        
        document.getElementById('copy-btn').addEventListener('click', function() {
            var text = document.getElementById('soap-output').innerText;
            navigator.clipboard.writeText(text);
            var origText = this.innerHTML;
            this.innerHTML = '‚úì Copied!';
            var self = this;
            setTimeout(function() { self.innerHTML = origText; }, 2000);
        });
        
        function loadNotes() {
            document.getElementById('notes-loading').classList.remove('hidden');
            document.getElementById('notes-empty').classList.add('hidden');
            document.getElementById('notes-list').innerHTML = '';
            
            api('/api/notes').then(function(data) {
                notes = data;
                document.getElementById('notes-loading').classList.add('hidden');
                if (notes.length === 0) {
                    document.getElementById('notes-empty').classList.remove('hidden');
                    return;
                }
                
                var groups = {};
                var today = new Date().toDateString();
                var yesterday = new Date(Date.now() - 86400000).toDateString();
                
                notes.forEach(function(note) {
                    var d = new Date(note.encounter_time || note.created_at);
                    var ds = d.toDateString();
                    var label = ds === today ? 'Today' : ds === yesterday ? 'Yesterday' : d.toLocaleDateString();
                    if (!groups[label]) groups[label] = [];
                    groups[label].push(note);
                });
                
                var list = document.getElementById('notes-list');
                // Sort date groups: Today first, Yesterday second, then by date descending
                var sortedDates = Object.keys(groups).sort(function(a, b) {
                    if (a === 'Today') return -1;
                    if (b === 'Today') return 1;
                    if (a === 'Yesterday') return -1;
                    if (b === 'Yesterday') return 1;
                    return new Date(b) - new Date(a);
                });
                sortedDates.forEach(function(date) {
                    // Sort notes within group by encounter_time/created_at descending
                    groups[date].sort(function(a, b) {
                        var sa = a.encounter_time || a.created_at;
                        var sb = b.encounter_time || b.created_at;
                        // Handle date format with space instead of T
                        if (sa && sa.indexOf('T') === -1) sa = sa.replace(' ', 'T') + 'Z';
                        if (sb && sb.indexOf('T') === -1) sb = sb.replace(' ', 'T') + 'Z';
                        var ta = new Date(sa);
                        var tb = new Date(sb);
                        return tb - ta;
                    });
                    var group = document.createElement('div');
                    group.className = 'date-group';
                    group.innerHTML = '<div class="date-group-header">' + date + '</div>';
                    
                    groups[date].forEach(function(note) {
                        var card = document.createElement('div');
                        card.className = 'note-card';
                        card.dataset.id = note.id;
                        
                        var title = generateNoteTitle(note.encounter_time || note.created_at, note.patient_age, note.patient_gender, note.chief_complaint);
                        var labelHtml = note.label ? '<div class="note-label">' + note.label + '</div>' : '';
                        
                        card.innerHTML = '<div class="note-header"><span class="note-title">' + title + '</span></div>' + labelHtml + '<div class="note-content"></div>';
                        group.appendChild(card);
                    });
                    list.appendChild(group);
                });
            }).catch(function() {
                document.getElementById('notes-loading').classList.add('hidden');
            });
        }
        document.getElementById('notes-list').addEventListener('click', function(e) {
            var card = e.target.closest('.note-card');
            if (!card || e.target.closest('button')) return;
            
            var id = card.dataset.id;
            var content = card.querySelector('.note-content');
            
            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                return;
            }
            
            document.querySelectorAll('.note-card').forEach(function(c) { c.classList.remove('expanded'); });
            card.classList.add('expanded');
            content.innerHTML = '<div class="spinner"></div>';
            
            api('/api/notes/' + id).then(function(note) {
                var title = generateNoteTitle(note.encounter_time || note.created_at, note.patient_age, note.patient_gender, note.chief_complaint);
                content.innerHTML = '<div class="soap-title" style="margin-bottom:12px;">' + title + '</div>' +
                    '<div class="soap-output">' + (note.soap_note || '').replace(/\*\*(SUBJECTIVE|OBJECTIVE|ASSESSMENT|PLAN):?\*\*/gi, '<div class="soap-section-header">$1</div>').replace(/^(SUBJECTIVE|OBJECTIVE|ASSESSMENT|PLAN):?$/gim, '<div class="soap-section-header">$1</div>').replace(/\(ICD-10 codes suggested[^)]*\)/g, '<span class="soap-disclaimer">$&</span>').replace(/^(\d+\.\s+.*)$/gm, '<span class="soap-plan-item">$1</span>').replace(/^(\s+-\s+.*)$/gm, '<span class="soap-plan-subitem">$1</span>').replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>') + '</div>' +
                    '<div class="note-actions">' +
                    '<button class="btn btn-secondary btn-sm" onclick="copyNoteText(this)">Copy</button>' +
                    '<button class="btn btn-danger btn-sm" onclick="deleteNote(' + id + ')">Delete</button>' +
                    '</div>';
            });
        });
        
        window.copyNoteText = function(btn) {
            var text = btn.parentElement.previousElementSibling.innerText;
            navigator.clipboard.writeText(text);
            btn.textContent = 'Copied!';
            setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
        };
        
        window.deleteNote = function(id) {
            if (!confirm('Delete this note?')) return;
            api('/api/notes/' + id, { method: 'DELETE' }).then(function() { loadNotes(); });
        };
    })();
    </script>
</body>
</html>
